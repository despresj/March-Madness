---
title: "March Madness Basketball Turniment"
author: "Sabrina Ball and Joe Despres"
date: "updated: `r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=15,
                      fig.height=12, 
                      echo = FALSE, 
                      message = FALSE,
                      warning = FALSE, 
                      comment = "")

library(tidyverse)
library(kableExtra)
library(patchwork)

merged <- readr::read_csv(here::here("data", "merged.csv"))
ids <- readr::read_csv(here::here("data", "ids.csv"))
s2021 <- readr::read_csv(here::here("data", "s2021.csv"))
source(here::here("R", "fitting.R"))
theme_set( theme_light(base_size = 25))
```

background-image: url(https://upload.wikimedia.org/wikipedia/en/2/28/March_Madness_logo.svg)

---

# Backround

--

- First tournament was in 1939 only 8 teams

--

- Now, its restricted to the top 64 NCAA Division I Teams

--

- Only one team has ever gone undefeated thought a season and the tournament

--

- 16.9 Million Viewers

--

- MSU won in 1979 and 2000

--

- When the turiment starts we form small groups and gamble on the outcomes. Usually by selecting winners and loser from the backet until we have a completely filled out turniment

--

- Nobody has ever made a perfect bracket and there are $2^{63}$ possible outcomes.

---

![](images/empty_bracket.jpg)

---
class: center, middle
# Zoomed in

![](images/zoomed.png)

---

class: inverse

# Using basketball seasion data to predict this year's turniment outcomes requires us to:

### Design predive models to make out of sample predictions

--

### Derrive a scoring metric

--

### Evaluate and tune the model

--

### We made several models, In the interstst of time we are going to discuss the logistic because its the most straight-forward


---
class: center


```{r fig.width=15, fig.height=12}
hists <- merged %>%
  select(x3fg, fg_percent, rpg, st, to,  bkpg)

histogram <- function(x, t){
  ggplot(data = hists, aes(x)) +
    geom_histogram(bins = 55, color = "white", fill = "black") +
    theme_light(base_size = 25) +
    labs(title = paste0("", t), x = "", y = "") +
    NULL

}

a <- histogram(merged$x3fg,       t = "Three-Points Goals")
b <- histogram(merged$fg_percent, t = "Percentage of Goals Scored")
c <- histogram(merged$rpg,        t = "Rebounds Per Game")
d <- histogram(merged$st,         t = "Steals Per Game")
e <- histogram(merged$to,         t = "Turnovers Per Game")
f <- histogram(merged$bkpg,       t = "Blocks Per game")
# (a + b + c) / (d + e + f)
(a + b) / (c + d) /(e + f)
```

---

# Real Quick Descriptive Statisticcs

```{r}
descriptive_statistics <- function(x){
  output <- c(mean(x), median(x), sd(x), min(x), max(x))
  output <- round(output, digits = 2)
  return(output)
}

desc_stats <- merged %>%
  select(fg_percent, ft_percent, rpg,st, to, bkpg) %>%
  map_df(descriptive_statistics) %>%
  t()

colnames(desc_stats) <- c("Mean", "Median", "Std. Dev", "Min", "Max")
rownames(desc_stats) <- c("Field Goal Percentage", "Free Throw Percentage", "Rebounds Per Game", "Steals", "Turnovers", "Blocked Shots Per Game")

kable(desc_stats) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

seasion_seasion <- merged %>%
  nrow()

# n teams
unique_teams <- length(unique(merged$team_id))

# 64 teams in the turniment.

cbind(
    `Games Played` = seasion_seasion,
      Teams = unique_teams,
      Turniment = 64) %>%
  kable() %>%
  kable_styling(bootstrap_options = "striped",
                full_width = F,
                position = "center")
```


- Normal-ish distributions

- No catastrophic skews or heavy tails

--

- Ideally we would have had steaks and turn-overs per game rather than season total. Not all played the same game


---

class: center

# Logistic Model

```{r}
equatiomatic::extract_eq(model = logistic_fit,
                         use_coefs = FALSE,
                         show_distribution = TRUE,
                         wrap = TRUE,
                         terms_per_line = 2,
                         intercept = "beta")
```

---
class: center

Summary

```{r}
row_name <- c("Intercept",
  "Three Pointers", "O* Three Pointers", 
          "Field Goal Percentage", "O* Field Goal Percentage",
          "Free-throw percentage", "O* Free-throw percentage",
          "Rebounds", "O* Rebounds",
          "Steals", "O* Steals",
          "Turnovers", "O* Turnovers",
          "Blocks", "O* Blocks"
          )

cols <- c("Term", "Estimate", "Std. Error", "T-Stat", "P-Value")

table_output <- function(obj, rows){
  broom::tidy(obj) %>%
  mutate(p.value = as.character(p.value), term = row_name) %>%
  mutate_if(is.numeric, round, 3) %>%
  mutate(p.value = as.numeric(p.value))  %>%
  kable(col.names = cols) %>%
  kable_styling(font_size = 15) %>%
  row_spec(rows, color = "white", background = "#025cba") %>% 
  add_footnote("Where O* is the Mertric associated with their opposing team", notation = "none")
}
  broom::tidy(logistic_fit) %>%
  mutate(p.value = as.character(p.value), term = row_name) %>%
  mutate_if(is.numeric, round, 3) %>%
  mutate(p.value = as.numeric(p.value))  %>%
  kable(col.names = cols) %>%
  kable_styling(font_size = 15) %>%
  # row_spec(rows, color = "white", background = "#025cba") %>% 
  add_footnote("Where O* is the Mertric associated with their opposing team", 
               notation = "none")

```


---
class: center
Summary



```{r}

table_output(obj = logistic_fit, rows = 2:3)
```

---
class: center
Summary

```{r}
table_output(obj = logistic_fit, rows = 4:5)
```

---
class: center
Summary

```{r}
table_output(obj = logistic_fit, rows = 6:7)
```

---
class: center
Summary

```{r}
table_output(obj = logistic_fit, rows = 8:9)
```

---
class: center
Summary

```{r}
table_output(obj = logistic_fit, rows = 10:11)
```

---
class: center
Summary

```{r}
table_output(obj = logistic_fit, rows = 12:13)
```

---
class: center
Summary

```{r}
table_output(obj = logistic_fit, rows = 14:15)
```

---
## Scoring

$$\sum_{i=1}^{n} [\mathbf {1} _{\{correct\ prediction\}} \hat{p_i} -\mathbf {1} _{incorrect\ perdiction}\hat{p_i} ] = Model\ Score$$

--

- Basketball games are often quite close and odds in betting markets are often close to 1:1. 

--

- Our goal Goal is to weight correct prediction higher when it assigns a higher probability. Conversely a lower score to an incorrect prediction.

--

- $E(Model\ Score) = 0$ if our predictions are no better than randomly guessing.

---


## Scoring

$$\sum_{i=1}^{n} [\mathbf {1} _{\{correct\ prediction\}} \hat{p_i} -\mathbf {1} _{incorrect\ perdiction}\hat{p_i} ] = Model\ Score$$

Minimal Example

```{r}
col_fix <- function(x){
  x <- str_replace(x, "_", " ")
  x <- str_to_title(x)
  x
}

logistic_model_score <- readRDS(here::here("cache", "logistic_model_score.RDS")) %>% 
  drop_na() %>% 
  head(10) %>% 
  mutate_if(is.character, str_to_title) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  mutate(phat = if_else(predicted_winner == winner, 
                          predicted_winner_probs, predicted_loser_probs)) %>% 
  rename_all(col_fix) %>%
  rename( `$\\hat{p}$` = Phat) %>% 
  select(Game, `Predicted Winner`, `Winner`, `$\\hat{p}$`, Score)
```


```{r}
logistic_model_score %>% 
  kable(align = "r") %>% 
  kable_styling(font_size = 15) 
```

---

## Scoring

$$\sum_{i=1}^{n} [\mathbf {1} _{\{correct\ prediction\}} \hat{p_i} -\mathbf {1} _{incorrect\ perdiction}\hat{p_i} ] = Model\ Score$$

Correct Predictions

```{r}
logistic_model_score %>% 
  kable(align = "r") %>% 
  kable_styling(font_size = 15) %>%
  column_spec(c(1:5), color =  ifelse(logistic_model_score$Score > 0, "white", "black"), 
              background = ifelse(logistic_model_score$Score > 0, "#025cba", "#f0f0f0"))
```

---

## Scoring

$$\sum_{i=1}^{n} [\mathbf {1} _{\{correct\ prediction\}} \hat{p_i} -\mathbf {1} _{incorrect\ perdiction}\hat{p_i} ] = Model\ Score$$

Score

```{r}
logistic_model_score %>% 
  kable(align = "r") %>% 
  kable_styling(font_size = 15) %>% 
  column_spec(c(5), color =  ifelse(logistic_model_score$Score > 0, "white", "black"), 
              background = ifelse(logistic_model_score$Score > 0, "#025cba", "#ff3700"))
```
  

```{r fig.align='right'}
paste0("Model Score = ", sum(as.numeric(logistic_model_score$Score))) %>% 
  kable(col.names = "$\\sum_{i}Score$") %>% 
  kable_styling(font_size = 15) %>% 
  row_spec(1, color = "white", background = "#025cba")
```

---


```{r}
perform <- readRDS(here::here("cache", "logistic_model_score.RDS")) %>% 
  mutate(outcome = if_else(score > 0, "Correct", "Incorrect")) %>% 
  drop_na() 
```


```{r fig.height=10}

a <- perform %>%
  ggplot(aes(x = abs(score), fill = outcome)) + 
   geom_histogram(alpha=0.7, position="identity", bins = 10) + 
  labs(title = "Histogram of Scores", x = "Absolute Value of Score") +
  scale_fill_manual(values = c("#025cba", "#ff3700"))


b <- perform %>% 
  ggplot(aes(as.factor(outcome), fill = outcome)) + 
  geom_bar(alpha = 0.7) + 
  labs(title = "", x = "") + 
  scale_fill_manual(values = c("#025cba", "#ff3700")) +
  geom_text(size=10, color = "grey80", stat = 'count', aes(label =..count.., hjust = 1.5)) + 
  coord_flip()

a/b
```

```{r}
t2 <- perform %>% 
  summarise(totalscore = sum(score),
            se = sd(score), 
            t = totalscore/se,
              p = pt(t, nrow(perform)-1, lower.tail = F)) %>% 
  t()

score <- perform %>% 
  group_by(outcome) %>% 
  summarise(totalscore = sum(score)) %>% 
  mutate(totalscore = round(totalscore, 2))
  
t1 <- rbind(score, c("Total", sum(score$totalscore))) 
```

```{r}
knitr::kable(list(t1, t2)) %>% 
  kable_styling(font_size = 10)
  
```

---
class: inverse

# Conclusion

### Logistic Regression performs well. Given measured statists.

### However out model is independent of the pervious game which would aplify shortcommings. 




